{% extends 'base.html' %}

{% block title %} Main Page {% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-4 ps-2">
                <div class="tool-bar mt-1 my-1">
                    <div class="row mx-1 mt-4">
                        <table id="applications" class="table table-striped" style="width:100%">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Device ID</th>
                                    <th>Status</th>
                                    <th>Last Update</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="w-100 d-flex px-3 py-1 mt-4">
                        <input type="text" class="me-2" name="daterange" value="01/01/2018 - 01/15/2018" />
                        <button type="button" class="btn btn-success btn-apply">Apply</button>
                    </div>
                    <div class="row mx-3 my-1">
                        <button type="button" class="btn btn-success">Export CSV</button>
                    </div>
                </div>
            </div>
            <div class="col-md-9 col-lg-8">
                <div id="map">
    
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function(){
            const rowsData = JSON.parse('{{ rows|safe }}');
            console.log(rowsData)
            var map = L.map('map').setView([-34.4450409, 150.8531664], 13);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
        
            rowsData.map(item => {
                var marker = L.marker([item[1], item[2]]).addTo(map); 
            })

            /* $('select').change(function() {
                var truckId = $(this).val();
                $.ajax({
                  url: '/get-id-tracks/',
                  type: 'POST',
                  data: {'id':truckId},
                  success: function(response) {
                    console.log(response)
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });
                    map.setView([response.rows[0][1], response.rows[0][2]], 19);
                    response.rows.map(item => {
                        var marker = L.marker([item[1], item[2]]).addTo(map); 
                    })                    
                  },
                  error: function(xhr) {
                    console.log(xhr.responseText);
                  }
                });
              });
            */
            $(function() {
                $('input[name="daterange"]').daterangepicker({
                    opens: 'left'
                }, function(start, end, label) {
                    console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                });
            });

            $('#applications').DataTable({
                processing: true,
                serverSide: true,
                lengthChange:false,
                searching: false,
                columnDefs: [ {
                    orderable: false,
                    className: 'select-checkbox',
                    targets:   0,
                    checkboxes: {
                        selectRow: true,
                        selectAllPages: false
                    }
                } ],
                select: {
                    style: 'multi',
                    selector: 'td:first-child'
                },
                order: [[ 1, 'asc' ]],
                fnRowCallback: function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                    style = timestyle(aData.time)
                    $('td', nRow).css('background-color', style);
                },
                ajax: {
                    url : 'get-data/',
                    type : 'POST',
                },
                columns: [
                    {
                        data:null, 
                        orderable:false, 
                        render:function(data, type, full, meta){
                            return "";
                        }
                    },
                    {data:'id'},
                    {
                        data:'status', 
                        orderable:false,
                        render: function(data, type, row) {
                            if(data == "1")
                                return "ONLINE"
                            else
                                return "OFFLINE" 
                        }
                    },
                    {
                        data:'time',
                        render: function(data, type, row) {
                            var changed = timeformat(data)
                            return changed
                        }
                    },
                ]
            });

            var table = $('#applications').DataTable();
            $('#applications tbody').on('click', 'tr', function () {
                // Toggle the selected class on the selected row
                $(this).toggleClass('selected');
            
                // Get selected rows and log their data
                var selectedRows = table.rows('.selected').data();

                console.log(selectedRows)
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                if(selectedRows.length > 0){
                    map.setView([selectedRows[0].lat, selectedRows[0].lon], 19);
                }

                selectedRows.each(function (rowData) {
                    var marker = L.marker([rowData.lat, rowData.lon]).addTo(map); 
                });
            });

            function timeformat(data){
                prevtime = parseInt(data)
                m_date = new Date(prevtime).toISOString()
                datetime = m_date.substr(0, 10) + " " + m_date.substr(11, 8);
                return datetime
            }
            function timestyle(data){
                prevtime = parseInt(data)
                currenttime = Date.now()
                timedivide = currenttime - prevtime
                console.log(timedivide)
                if (timedivide < 600000)
                    return "#7af57a"
                if(timedivide > 14400000){
                    return '#ff7588'
                }
                if (timedivide > 600000){
                    return '#fcc772'
                }
                
            }
        })
    </script>
    
{% endblock %}